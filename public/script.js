const calendar=document.getElementById("calendar"),mesAtualEl=document.getElementById("mesAtual"),btnAnterior=document.getElementById("btnAnterior"),btnProximo=document.getElementById("btnProximo"),nomesMeses=["Janeiro","Fevereiro","Mar칞o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","S치b"];let hoje=new Date,mesAtual=hoje.getMonth(),anoAtual=hoje.getFullYear(),agendamentos={},statusDias={};function segundoDomingo(e,a){let t=1,o=0;for(;t<=14;){if(0===new Date(a,e,t).getDay()&&o++,2===o)return t;t++}return null}function feriadosBloqueados(e){return[{dia:24,mes:11},{dia:25,mes:11},{dia:31,mes:11},{dia:12,mes:9},{dia:segundoDomingo(4,e),mes:4},{dia:segundoDomingo(7,e),mes:7}].filter((e=>null!==e.dia))}function carregarAgendamentosDoBanco(e=0){Promise.all([fetch("https://terrazzo-6lae.onrender.com/agendamentos").then((e=>e.json())),fetch("https://terrazzo-6lae.onrender.com/status-dia").then((e=>e.json()))]).then((([e,a])=>{agendamentos={},statusDias={},e.forEach((e=>{const[a,t,o]=e.dia.split("-").map((e=>parseInt(e,10))),n=`${o}-${t-1}-${a}`;agendamentos[n]||(agendamentos[n]=[]),agendamentos[n].push({nome:e.nome,horario:e.horario,diaTodo:e.dia_todo})})),a.forEach((e=>{const[a,t,o]=e.dia.split("-").map((e=>parseInt(e,10)));statusDias[`${o}-${t-1}-${a}`]=e.status})),criarCalendario(mesAtual,anoAtual)})).catch((e=>{console.error("Erro ao carregar dados:",e.message),calendar.innerHTML='<p class="erro-calendario">游뛂 Erro ao carregar dados. Tente atualizar a p치gina.</p>'}))}function criarCalendario(e,a){calendar.innerHTML="",mesAtualEl.textContent=`${nomesMeses[e]} ${a}`;const t=new Date(a,e+1,0).getDate();feriadosBloqueados(hoje.getFullYear()+1);for(let o=1;o<=t;o++){const t=`${o}-${e}-${a}`,n=new Date(a,e,o),r=diasSemana[n.getDay()],s=document.createElement("div");s.className="day";const i=o===hoje.getDate()&&e===hoje.getMonth()&&a===hoje.getFullYear();s.innerHTML=`\n      <h3 class="${i?"hoje-vermelho":""}">${o}</h3>\n      <p class="dia-sem">${r}</p>\n    `;const d=agendamentos[t]||[],l=d.length,c=d.some((e=>e.diaTodo));s.classList.remove("dia-verde","dia-amarelo","dia-vermelho"),l>=3||c?s.classList.add("dia-vermelho"):2===l?s.classList.add("dia-amarelo"):1===l&&s.classList.add("dia-verde");const u=feriadosBloqueados(a).some((a=>a.dia===o&&a.mes===e))&&hoje<new Date(a,0,1),m="manutencao"===statusDias[t]||"bloqueado"===statusDias[t];if(l<3&&!c&&!u&&!m){const n=document.createElement("button");n.className="btn-plus",n.innerText="+",n.onclick=()=>abrirFormulario(t,o,e,a),s.appendChild(n)}let h;d.forEach((e=>{const a=document.createElement("div");a.className="agendado",a.textContent=`${e.nome} - ${e.horario}`,s.appendChild(a)}));const p=()=>{h=setTimeout((()=>{abrirModalSenha(o,e,a)}),5e3)},g=()=>clearTimeout(h);if(s.addEventListener("mousedown",p),s.addEventListener("mouseup",g),s.addEventListener("mouseleave",g),s.addEventListener("touchstart",p),s.addEventListener("touchend",g),s.addEventListener("touchcancel",g),statusDias[t]){s.classList.add("dia-vermelho-borda");const e=document.createElement("div");e.className="status-dia",e.textContent="manutencao"===statusDias[t]?"Em Manuten칞칚o":"Indisponivel Hoje",s.appendChild(e)}calendar.appendChild(s)}}function abrirModalSenha(e,a,t){const o=document.createElement("div");o.className="modal-overlay";const n=document.createElement("div");n.className="modal-content",n.innerHTML='\n    <h3>Acesso restrito</h3>\n    <input type="password" placeholder="Digite a senha" />\n    <button>Entrar</button>\n  ',n.querySelector("button").onclick=()=>{"terrazzo125"===n.querySelector("input").value?(document.body.removeChild(o),abrirModalStatus(e,a,t)):alert("Senha incorreta.")},o.appendChild(n),document.body.appendChild(o)}function abrirModalStatus(e,a,t){const o=document.createElement("div");o.className="modal-overlay";const n=document.createElement("div");n.className="modal-content",n.innerHTML='\n    <h3>Selecionar status do espa칞o</h3>\n    <select>\n      <option value="">-- Escolha uma op칞칚o --</option>\n      <option value="manutencao">Espa칞o em Manuten칞칚o</option>\n      <option value="bloqueado">Indispon칤vel Hoje</option>\n    </select>\n    <button>Aplicar</button>\n  ',n.querySelector("button").onclick=()=>{const r=n.querySelector("select").value;if(!r)return alert("Selecione uma op칞칚o.");const s=`${e}-${a}-${t}`,i=`${t}-${a+1}-${e}`;socket.emit("status-dia",{dia:i,status:r}),aplicarStatusDia(s,r),document.body.removeChild(o)},o.appendChild(n),document.body.appendChild(o)}function aplicarStatusDia(e,a){const t=[...document.querySelectorAll(".day")].find((a=>a.querySelector("h3")?.textContent==e.split("-")[0]));if(t){t.classList.add("dia-vermelho-borda");const e=t.querySelector(".status-dia");e&&e.remove();const o=document.createElement("div");o.className="status-dia",o.textContent="manutencao"===a?"Em Manuten칞칚o":"Indispon칤vel Hoje",t.appendChild(o)}}function abrirFormulario(e,a,t,o){const n=feriadosBloqueados(o).some((e=>e.dia===a&&e.mes===t)),r=new Date(o,0,1);if(n&&hoje<r)return void alert("游뛂 Esse feriado do ano seguinte s칩 poder치 ser reservado ap칩s o dia 1췈 de Janeiro para garantir justi칞a a todos.");const s=document.createElement("div");s.className="modal-overlay";const i=document.createElement("div");i.className="modal-content",i.innerHTML='\n    <button class="fechar">X</button>\n    <form class="form-inline">\n      <input type="text" placeholder="Nome" required />\n      <div class="hora-bloco">\n        <label>In칤cio:</label>\n        <input type="time" class="hora-inicio" required />\n        <label>T칠rmino:</label>\n        <input type="time" class="hora-fim" required />\n      </div>\n      <div class="checkbox-wrapper">\n        <input type="checkbox" id="diaTodo" />\n        <span class="texto-dia-todo">Reservar o dia todo</span>\n      </div>\n      <button type="submit">Agendar</button>\n    </form>\n  ',i.querySelector(".fechar").onclick=()=>document.body.removeChild(s);const d=i.querySelector("form"),l=i.querySelector("#diaTodo"),c=i.querySelector(".hora-inicio"),u=i.querySelector(".hora-fim");l.onchange=()=>{const e=l.checked;c.disabled=e,u.disabled=e,c.style.opacity=e?"0.5":"1",u.style.opacity=e?"0.5":"1"},d.onsubmit=e=>{e.preventDefault();const n=d.querySelector("input[type='text']").value.trim(),r=c.value,i=u.value,m=l.checked;if(!n||!m&&r>=i)return void alert("Preencha todos os campos corretamente e verifique os hor치rios.");const h=m?"Dia inteiro":`${r} - ${i}`,p=new Date(o,t,a).toISOString().split("T")[0];fetch("https://terrazzo-6lae.onrender.com/agendamentos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nome:n,horario:h,dia:p,dia_todo:m})}).then((e=>{if(!e.ok)throw new Error(`Erro ${e.status} ao enviar agendamento`);return e.json()})).then((()=>{document.body.removeChild(s),socket.emit("atualizar")})).catch((e=>{alert("Erro ao agendar. Tente novamente."),console.error("丘멆잺 Falha no envio:",e.message)}))},s.appendChild(i),document.body.appendChild(s)}btnAnterior.onclick=()=>{mesAtual=0===mesAtual?11:mesAtual-1,anoAtual=11===mesAtual?anoAtual-1:anoAtual,carregarAgendamentosDoBanco()},btnProximo.onclick=()=>{mesAtual=11===mesAtual?0:mesAtual+1,anoAtual=0===mesAtual?anoAtual+1:anoAtual,carregarAgendamentosDoBanco()},carregarAgendamentosDoBanco();const socket=io("https://terrazzo-6lae.onrender.com");socket.on("atualizar",(()=>{console.log("游니 Evento recebido: atualizar"),carregarAgendamentosDoBanco()}));const estiloExtra=document.createElement("style");estiloExtra.textContent="\n  .dia-vermelho-borda {\n    border-left-color: #818181ff;\n  }\n  .status-dia {\n    margin-top: 5px;\n    font-weight: bold;\n    color: #818181ff;\n    text-align: left;\n  }\n",document.head.appendChild(estiloExtra),setInterval((()=>{console.log("游댃 Atualizando calend치rio automaticamente..."),carregarAgendamentosDoBanco()}),2e3);